<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ライトウェブ2.0</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain; /* 画像が画面に収まるように調整 */
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            filter: brightness(0.5);
            transition: background-image 0.5s ease-in-out;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Light Web 2.0</h1>
    </header>

    <section class="icons">
        <a href="https://www.google.com" target="_blank" class="icon" id="google"><span>Google</span></a>
        <a href="https://www.youtube.com" target="_blank" class="icon" id="youtube"><span>YouTube</span></a>
        <a href="https://www.bilibili.com" target="_blank" class="icon" id="bilibili"><span>bilibili</span></a>
        <a href="https://www.nicovideo.jp" target="_blank" class="icon" id="nicovideo"><span>ニコニコ</span></a>
        <a href="https://mail.google.com" target="_blank" class="icon" id="gmail"><span>Gmail</span></a>
    </section>

    <footer>
        <form action="https://www.google.com/search" method="get" target="_blank">
            <input type="text" id="search" name="q" placeholder="Google 検索">
            <button type="submit">検索</button>
        </form>
    </footer>
</div>

<script>
    const API_KEY = "mM1N8_WeA0zLgqur9yVliCSNcrDOEs2M9Q-oOWqMUFA";
    const query = "akihabara,japan,city";
    const MAX_IMAGES = 20;
    const COOKIE_NAME = "bg_images";

    // クッキーからデータを取得
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
    }

    // クッキーをセット
    function setCookie(name, value, days = 30) {
        const expires = new Date(Date.now() + days * 864e5).toUTCString();
        document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    // クッキーからランダムURL取得
    function getRandomImageUrlFromCookies() {
        const cookie = getCookie(COOKIE_NAME);
        if (!cookie) return null;

        const urls = JSON.parse(cookie);
        if (urls.length === 0) return null;

        return urls[Math.floor(Math.random() * urls.length)];
    }

    // クッキーにURLを保存
    function saveImageUrlToCookies(url) {
        let urls = [];
        const existing = getCookie(COOKIE_NAME);
        if (existing) {
            urls = JSON.parse(existing);
        }

        if (!urls.includes(url)) {
            urls.push(url);
            if (urls.length > MAX_IMAGES) {
                urls.shift();
            }
            setCookie(COOKIE_NAME, JSON.stringify(urls));
        }
    }

    // 背景を設定
    async function setBackground() {
        try {
            const response = await fetch(`https://api.unsplash.com/photos/random?query=${query}&orientation=landscape&client_id=${API_KEY}`);
            const data = await response.json();

            if (data && data.urls && data.urls.full) {
                const url = data.urls.full;
                document.body.style.backgroundImage = `url(${url})`;
                saveImageUrlToCookies(url);
                return;
            }

            throw new Error("画像が取得できませんでした。");

        } catch (error) {
            console.warn("API失敗、保存済み画像から選びます：", error);
            const url = getRandomImageUrlFromCookies();
            if (url) {
                document.body.style.backgroundImage = `url(${url})`;
            } else {
                document.body.style.backgroundColor = "#000"; // fallback
            }
        }
    }

    setBackground();
</script>
</body>
</html>
